class JSHeap{slots;freeIds;maxId;constructor(){this.slots=[],this.freeIds=[],this.maxId=0}insert(value){let id;if(this.freeIds.length>0)id=this.freeIds.pop();else id=this.maxId,this.maxId++;return this.slots[id]=value,id}get(id){return this.slots[id]}remove(id){let value=this.slots[id];if(value!==void 0)this.slots[id]=void 0,this.freeIds.push(id);return value}has(id){return this.slots[id]!==void 0}}class DataEncoder{u8Buf;u16Buf;u32Buf;strBuf;constructor(){this.u8Buf=[],this.u16Buf=[],this.u32Buf=[],this.strBuf=[]}pushU8(value){this.u8Buf.push(value&255)}pushU16(value){this.u16Buf.push(value&65535)}pushU32(value){this.u32Buf.push(value>>>0)}pushU64(value){let low=value>>>0,high=Math.floor(value/4294967296)>>>0;this.pushU32(low),this.pushU32(high)}pushStr(value){let encoded=new TextEncoder().encode(value);this.pushU32(encoded.length);for(let i=0;i<encoded.length;i++)this.strBuf.push(encoded[i])}finalize(){let u16Offset=12+this.u32Buf.length*4,u8Offset=u16Offset+this.u16Buf.length*2,strOffset=u8Offset+this.u8Buf.length,totalSize=strOffset+this.strBuf.length,buffer=new ArrayBuffer(totalSize),dataView=new DataView(buffer);dataView.setUint32(0,u16Offset,!0),dataView.setUint32(4,u8Offset,!0),dataView.setUint32(8,strOffset,!0);let offset=12;for(let val of this.u32Buf)dataView.setUint32(offset,val,!0),offset+=4;for(let val of this.u16Buf)dataView.setUint16(offset,val,!0),offset+=2;return new Uint8Array(buffer,u8Offset,this.u8Buf.length).set(this.u8Buf),new Uint8Array(buffer,strOffset,this.strBuf.length).set(this.strBuf),buffer}}class DataDecoder{u8Buf;u8Offset;u16Buf;u16Offset;u32Buf;u32Offset;strBuf;strOffset;constructor(data){let headerView=new DataView(data,0,12),u16ByteOffset=headerView.getUint32(0,!0),u8ByteOffset=headerView.getUint32(4,!0),strByteOffset=headerView.getUint32(8,!0),u32ByteLength=u16ByteOffset-12;this.u32Buf=new Uint32Array(data,12,u32ByteLength/4),this.u32Offset=0;let u16ByteLength=u8ByteOffset-u16ByteOffset;this.u16Buf=new Uint16Array(data,u16ByteOffset,u16ByteLength/2),this.u16Offset=0;let u8ByteLength=strByteOffset-u8ByteOffset;this.u8Buf=new Uint8Array(data,u8ByteOffset,u8ByteLength),this.u8Offset=0,this.strBuf=new Uint8Array(data,strByteOffset),this.strOffset=0}takeU8(){return this.u8Buf[this.u8Offset++]}takeU16(){return this.u16Buf[this.u16Offset++]}takeU32(){return this.u32Buf[this.u32Offset++]}takeU64(){let low=this.takeU32(),high=this.takeU32();return low+high*4294967296}takeStr(){let len=this.takeU32(),bytes=this.strBuf.subarray(this.strOffset,this.strOffset+len);return this.strOffset+=len,new TextDecoder("utf-8").decode(bytes)}}function sync_request_binary(endpoint,data){let xhr=new XMLHttpRequest;xhr.open("POST",endpoint,!1),xhr.responseType="arraybuffer";let bytes=new Uint8Array(data),binary="";for(let i=0;i<bytes.length;i++)binary+=String.fromCharCode(bytes[i]);let base64=btoa(binary);if(xhr.setRequestHeader("dioxus-data",base64),xhr.send(),xhr.status===200&&xhr.response&&xhr.response.byteLength>0)return xhr.response;return null}function evaluate_from_rust_binary(fnId,dataBase64){let binary=atob(dataBase64),bytes=new Uint8Array(binary.length);for(let i=0;i<binary.length;i++)bytes[i]=binary.charCodeAt(i);let data=bytes.buffer,decoder=new DataDecoder(data),msgType=decoder.takeU8(),decodedFnId=decoder.takeU32(),spec=window.functionRegistry[fnId];if(!spec)throw new Error("Unknown function ID: "+fnId);let encoder=new DataEncoder;encoder.pushU8(1),spec(decoder,encoder);let response=sync_request_binary("wry://handler",encoder.finalize());return handleBinaryResponse(response)}function handleBinaryResponse(response){if(!response||response.byteLength===0)return;let decoder=new DataDecoder(response),msgType=decoder.takeU8();if(msgType===1)return;else if(msgType===0){let fnId=decoder.takeU32(),spec=window.functionRegistry[fnId];if(!spec)throw new Error("Unknown function ID in response: "+fnId);let encoder=new DataEncoder;encoder.pushU8(1),spec(decoder,encoder);let nextResponse=sync_request_binary("wry://handler",encoder.finalize());return handleBinaryResponse(nextResponse)}return}class RustFunction{fnId;constructor(fnId){this.fnId=fnId}call(){let encoder=new DataEncoder;encoder.pushU8(0),encoder.pushU32(0),encoder.pushU64(this.fnId);let response=sync_request_binary("wry://handler",encoder.finalize());return handleBinaryResponse(response)}}class BoolType{encode(encoder,value){encoder.pushU8(value?1:0)}decode(decoder){return decoder.takeU8()!==0}}class HeapRefType{encode(encoder,obj){let id=window.jsHeap.insert(obj);encoder.pushU64(id)}decode(decoder){let id=decoder.takeU64();return window.jsHeap.get(id)}}class StringType{encode(encoder,value){encoder.pushStr(value)}decode(decoder){return decoder.takeStr()}}class CallbackType{paramTypes;returnType;constructor(paramTypes,returnType){this.paramTypes=paramTypes,this.returnType=returnType}encode(encoder,fnId){encoder.pushU64(fnId)}decode(decoder){let fnId=decoder.takeU64(),f=new RustFunction(fnId);return(...args)=>f.call()}}class NullType{encode(encoder,value){}decode(decoder){return null}}class NumericType{size;constructor(size){this.size=size}encode(encoder,value){switch(this.size){case"u8":encoder.pushU8(value);break;case"u16":encoder.pushU16(value);break;case"u32":encoder.pushU32(value);break;case"u64":encoder.pushU64(value);break}}decode(decoder){switch(this.size){case"u8":return decoder.takeU8();case"u16":return decoder.takeU16();case"u32":return decoder.takeU32();case"u64":return decoder.takeU64()}}}class OptionType{wrappedType;constructor(wrappedType){this.wrappedType=wrappedType}encode(encoder,value){if(value===null||value===void 0)encoder.pushU8(0);else encoder.pushU8(1),this.wrappedType.encode(encoder,value)}decode(decoder){if(decoder.takeU8()===0)return null;else return this.wrappedType.decode(decoder)}}function createWrapperFunction(paramTypes,returnType,jsFunction){return(decoder,encoder)=>{let params=paramTypes.map((paramType)=>paramType.decode(decoder));console.log("calling:",jsFunction.name),console.log("Decoded parameters:",params);let result=jsFunction(...params);returnType.encode(encoder,result)}}var U8Type=new NumericType("u8"),U16Type=new NumericType("u16"),U32Type=new NumericType("u32"),U64Type=new NumericType("u64"),strType=new StringType;var functionRegistry=[];window.setFunctionRegistry=(registry)=>{functionRegistry=registry};window.evaluate_from_rust_binary=evaluate_from_rust_binary;window.jsHeap=new JSHeap;window.createWrapperFunction=createWrapperFunction;window.BoolType=BoolType;window.HeapRefType=HeapRefType;window.NullType=NullType;window.OptionType=OptionType;window.CallbackType=CallbackType;window.U8Type=U8Type;window.U16Type=U16Type;window.U32Type=U32Type;window.U64Type=U64Type;
