class DataEncoder{u8Buf;u16Buf;u32Buf;strBuf;constructor(){this.u8Buf=[],this.u16Buf=[],this.u32Buf=[],this.strBuf=[]}pushU8(value){this.u8Buf.push(value&255)}pushU16(value){this.u16Buf.push(value&65535)}pushU32(value){this.u32Buf.push(value>>>0)}pushStr(value){let encoded=new TextEncoder().encode(value);this.pushU32(encoded.length);for(let i=0;i<encoded.length;i++)this.strBuf.push(encoded[i])}finalize(){let u16Offset=12+this.u32Buf.length*4,u8Offset=u16Offset+this.u16Buf.length*2,strOffset=u8Offset+this.u8Buf.length,totalSize=strOffset+this.strBuf.length,buffer=new ArrayBuffer(totalSize),dataView=new DataView(buffer);dataView.setUint32(0,u16Offset,!0),dataView.setUint32(4,u8Offset,!0),dataView.setUint32(8,strOffset,!0);let offset=12;for(let val of this.u32Buf)dataView.setUint32(offset,val,!0),offset+=4;for(let val of this.u16Buf)dataView.setUint16(offset,val,!0),offset+=2;return new Uint8Array(buffer,u8Offset,this.u8Buf.length).set(this.u8Buf),new Uint8Array(buffer,strOffset,this.strBuf.length).set(this.strBuf),buffer}}class DataDecoder{u8Buf;u8Offset;u16Buf;u16Offset;u32Buf;u32Offset;strBuf;strOffset;constructor(data){let headerView=new DataView(data,0,12),u16ByteOffset=headerView.getUint32(0,!0),u8ByteOffset=headerView.getUint32(4,!0),strByteOffset=headerView.getUint32(8,!0),u32ByteLength=u16ByteOffset-12;this.u32Buf=new Uint32Array(data,12,u32ByteLength/4),this.u32Offset=0;let u16ByteLength=u8ByteOffset-u16ByteOffset;this.u16Buf=new Uint16Array(data,u16ByteOffset,u16ByteLength/2),this.u16Offset=0;let u8ByteLength=strByteOffset-u8ByteOffset;this.u8Buf=new Uint8Array(data,u8ByteOffset,u8ByteLength),this.u8Offset=0,this.strBuf=new Uint8Array(data,strByteOffset),this.strOffset=0}takeU8(){return this.u8Buf[this.u8Offset++]}takeU16(){return this.u16Buf[this.u16Offset++]}takeU32(){return this.u32Buf[this.u32Offset++]}takeStr(){let len=this.takeU32(),bytes=this.strBuf.subarray(this.strOffset,this.strOffset+len);return this.strOffset+=len,new TextDecoder("utf-8").decode(bytes)}}class JSHeap{slots;freeIds;maxId;constructor(){this.slots=[],this.freeIds=[],this.maxId=0}insert(value){let id;if(this.freeIds.length>0)id=this.freeIds.pop();else id=this.maxId,this.maxId++;return this.slots[id]=value,id}get(id){return this.slots[id]}remove(id){let value=this.slots[id];if(value!==void 0)this.slots[id]=void 0,this.freeIds.push(id);return value}has(id){return this.slots[id]!==void 0}}var jsHeap=new JSHeap;function sync_request_binary(endpoint,data){let xhr=new XMLHttpRequest;xhr.open("POST",endpoint,!1),xhr.responseType="arraybuffer";let bytes=new Uint8Array(data),binary="";for(let i=0;i<bytes.length;i++)binary+=String.fromCharCode(bytes[i]);let base64=btoa(binary);if(xhr.setRequestHeader("dioxus-data",base64),xhr.send(),xhr.status===200&&xhr.response&&xhr.response.byteLength>0)return xhr.response;return null}class RustFunction{fnId;constructor(fnId){this.fnId=fnId}call(){let encoder=new DataEncoder;encoder.pushU32(0),encoder.pushU32(this.fnId);let response=sync_request_binary("wry://handler",encoder.finalize());return handleBinaryResponse(response)}}var functionRegistry=new Map;functionRegistry.set(0,{deserializeArgs:(d)=>[d.takeStr()],serializeReturn:()=>{},impl:(msg)=>console.log(msg)});functionRegistry.set(1,{deserializeArgs:(d)=>[d.takeStr()],serializeReturn:()=>{},impl:(msg)=>alert(msg)});functionRegistry.set(2,{deserializeArgs:(d)=>[d.takeU32(),d.takeU32()],serializeReturn:(e,v)=>e.pushU32(v),impl:(a,b)=>a+b});functionRegistry.set(3,{deserializeArgs:(d)=>[d.takeStr(),d.takeU32()],serializeReturn:()=>{},impl:(eventName,callbackId)=>{let rustFn=new RustFunction(callbackId);document.addEventListener(eventName,(e)=>{if(rustFn.call())e.preventDefault(),console.log("Event "+eventName+" default prevented by Rust callback.")})}});functionRegistry.set(4,{deserializeArgs:(d)=>[d.takeStr(),d.takeStr()],serializeReturn:()=>{},impl:(elementId,textContent)=>{let element=document.getElementById(elementId);if(element)element.textContent=textContent;else console.warn("Element with ID "+elementId+" not found.")}});functionRegistry.set(8,{deserializeArgs:(d)=>[d.takeU32()],serializeReturn:(e,v)=>e.pushU8(v?1:0),impl:(id)=>jsHeap.has(id)});functionRegistry.set(13,{deserializeArgs:()=>[],serializeReturn:(e,v)=>e.pushU32(v),impl:()=>jsHeap.insert(document.body)});functionRegistry.set(14,{deserializeArgs:(d)=>[d.takeStr()],serializeReturn:(e,v)=>{if(v===null||v===void 0)e.pushU8(0);else e.pushU8(1),e.pushU32(v)},impl:(selector)=>{let el=document.querySelector(selector);return el?jsHeap.insert(el):null}});functionRegistry.set(15,{deserializeArgs:(d)=>[d.takeStr()],serializeReturn:(e,v)=>e.pushU32(v),impl:(tag)=>jsHeap.insert(document.createElement(tag))});functionRegistry.set(16,{deserializeArgs:(d)=>[d.takeU32(),d.takeU32()],serializeReturn:()=>{},impl:(parentId,childId)=>{let parent=jsHeap.get(parentId),child=jsHeap.get(childId);parent.appendChild(child)}});functionRegistry.set(17,{deserializeArgs:(d)=>[d.takeU32(),d.takeStr(),d.takeStr()],serializeReturn:()=>{},impl:(elId,name,value)=>{jsHeap.get(elId).setAttribute(name,value)}});functionRegistry.set(18,{deserializeArgs:(d)=>[d.takeU32(),d.takeStr()],serializeReturn:()=>{},impl:(elId,text)=>{let el=jsHeap.get(elId);el.textContent=text}});function evaluate_from_rust_binary(fnId,dataBase64){let binary=atob(dataBase64),bytes=new Uint8Array(binary.length);for(let i=0;i<binary.length;i++)bytes[i]=binary.charCodeAt(i);let data=bytes.buffer,decoder=new DataDecoder(data),msgType=decoder.takeU32(),decodedFnId=decoder.takeU32();console.log("evaluate_from_rust_binary: fnId="+fnId+", msgType="+msgType+", decodedFnId="+decodedFnId);let spec=functionRegistry.get(fnId);if(!spec)throw new Error("Unknown function ID: "+fnId);let args=spec.deserializeArgs(decoder),result=spec.impl(...args),encoder=new DataEncoder;encoder.pushU32(1),spec.serializeReturn(encoder,result);let response=sync_request_binary("wry://handler",encoder.finalize());return handleBinaryResponse(response)}function handleBinaryResponse(response){if(!response||response.byteLength===0)return;let decoder=new DataDecoder(response),msgType=decoder.takeU32();if(msgType===1)return;else if(msgType===0){let fnId=decoder.takeU32(),spec=functionRegistry.get(fnId);if(!spec)throw new Error("Unknown function ID in response: "+fnId);let args=spec.deserializeArgs(decoder),result=spec.impl(...args),encoder=new DataEncoder;encoder.pushU32(1),spec.serializeReturn(encoder,result);let nextResponse=sync_request_binary("wry://handler",encoder.finalize());return handleBinaryResponse(nextResponse)}return}window.evaluate_from_rust_binary=evaluate_from_rust_binary;window.jsHeap=jsHeap;
